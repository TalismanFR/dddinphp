Глава 3. Объекты-Значения (The Value Objects)
==

Объекты-Значения являются фундаментальным строительным блоком DDD, и они используются для моделирования концепции вашего 
Единого Языка в коде. Объект Значения - это не просто вещь в вашем домене - 
он измеряет, определяем количество или описывает что-то. Объекты Значения могут рассматриваться
как небольшие простые объекты, такие как деньги или диапозон дат, равенство
которых основано не на идентификаторе, а на содержании.

Например, цена продукта может быть смоделирована с использованием Объекта Значения.
В данном случае это не вещь, а ценность, которая позволяет нам измерить, сколько
денег стоит продукт. Объем памяти для таких объектов легко определяется (рассчитывается
по составным частям), а накладных расходов очень мало. В результате создание нового экземпляра
предпочтительнее повторного использования ссылок, даже если Объект-Значения использоуется для
предоставления одного и того же значения. Равенство проверяется на основе сопоставимости
всех полей экземпляров.

## Определение
Уорд Каннингем (Ward Cunningham) дает следующее [определение](http://c2.com/cgi/wiki?ValueObject) Объекту Значения:
>Это мера или описание чего-либо. Примерами Объектов Значения являются такие вещи, как числа, даты, денежные суммы и строки.
>Обычно это не большие Объекты, которые используются довольно широко.
>Их идентичность основана на их состояни, а не на идентификаторе Объекта. 
>Таким образом, вы можете иметь несколько копий одного концептуального Объекта Значения.
>Каждая банкнота достоинством 5 долларов имеет свою собственную идентификацию (благодаря
>своему серийному номеру), но экономия денежных средств зависит от того, что
>каждая банкнота достоинством в 5 долларов имеет ту же стоимость, что и любая другая банкнота в 5 долларов.

Мартин Фаулер дает следующее [определение](http://martinfowler.com/bliki/ValueObject.html) Объекту Значения:
>Это маленький Объект, такой как деньги или диапозон дат. Их ключевое свойство
>заключается в том, что они следуют семантике значений, а не ссылочной семантике.
>Мы можем так утверждать, потому что их понятие равенства не основано на идентификаторе,
>вместо этого два Объекта Значения равны, если все их поля равны. 
>Хотя все поля равны, вам не нужно сравнивать все поля, если подмножество уникально - 
>например, кодов валюты для объектов валюты достаточно чтобы проверить равенство.
>Общая эвристика заключается в том, что Объекты Значения должны быть полностью неизменными.
>Если вы хотите изменить объект значения, вы должны заменить объект новым и не иметь
>возможности обновлять значения самого Объекта Значения. Обновляемые Объекты Значения приводят
>к проблемам с наложением имен.

Примерами Объектов Значения являются числа, текстовые строки, даты, время, полное имя человека
>***Упражнение***
>Попробуйте найти дополнительные Объекты Значения в вашем текущем Домене.

## Объекты значения vs Сущности

Рассмотрим следующие примеры из [Википедии](http://en.wikipedia.org/wiki/Domain-driven_design#Building_blocks_of_DDD), чтобы лучше понять разница между
Объектами Значениями и Сущностями:
- Объект Значения. Когда люди обменивают долларовые банкноты, они обычно не 
различают каждый уникальную купюру; они обеспокоены только номинальной стоимостью
долларовой банкноты. В этом контексте далларовые банкноты ялвяются Объектами Значения.
Тем не менее, Федеральный Резерв может быть обеспокоен каждым уникальным счетом; в этом контексте
каждый счет был бы сущностью.
- Сущность. Большинство авиакомпаний различают каждое место уникально на каждом рейсе.
Каждое место в данном контексте является сущностью. Однако Southwest Airlines, EasyJet и
Ryanair не различают каждое место; все места одинаковые. В этом контексте место на самом деле является
Объектом Значения.

>***Упражнение***
>Подумайте о понятии адреса (индекс, улица, номер дома и т.д.). Каков возможный
>контекст, в котором адрес может быть смоделирован как сущность, а не как объект значения? 
>Обсудите ваши выводы с коллегами.

## Пример "Валюта" и "Стоимость"

Объекты Значения "Валюта" и "Денежная Стоимость", вероятно, являются наиболее
часто используемыми примерами для объяснения Объектов Значения, благодаря 
[патерну "Деньги" (Money)](http://martinfowler.com/eaaCatalog/money.html).
Этот шаблон проектирования предоставляет решение для моделирования задачи, которая позволяет
избежать проблемы округления с плавающей запятой, что, в свою очередь, позволяет выполнять
детерминированные вычисления.

В реальном мире валюта описывает денежные единицы так же, как метры и ярды описывают единицы расстояния.
Каждая валюта представлена трехбуквенным ISO кодом в верхнем регистре:
```php
class Currency
{
    private $isoCode;
    public function __construct($anIsoCode)
    {
        $this->setIsoCode($anIsoCode);
    }

    private function setIsoCode($anIsoCode)
    {
        if (!preg_match('/^[A-Z]{3}$/', $anIsoCode)) {
            throw new InvalidArgumentException();
        }
        $this->isoCode = $anIsoCode;
    }

    public function isoCode()
    {
        return $this->isoCode;
    }
}
```
Одна из основных целей Объектов Значения так же являются святым Граалем ООП: инкапсуляция.
Следуя этому шаблону, вы получите выделенное место для размещения всей проверки,
логики сравнения и поведения для данной концепции.

>***Дополнительные Проверки Валюты***
>В предыдущем примере кода мы можем построить валюту с кодом ISO равным ААА.
>Это не валидно, валюты с такой кодировкой не существует. Напишите более конкретное правило,
>которое проверит, действителен ли код ISO. Полный список действительный валютных кодов ISO 
>можно найти 
>[здесь](https://www.xe.com/iso4217.php). Если вам нужна помощь, взгляните на библиотеку 
>[Money Packagist](https://github.com/moneyphp/money)

Деньги используются для измерения определенной суммы валюты. Они моделируются с 
помощью суммы и валюты. Сумма, в случае паттерна Money, реализуется с использованием
целочисленного представления наименее значимой доли валюты - например, в центах долларов США или 
копеек в рублях России.

В качестве бонуса вы также можете заметить, что мы используем самоинкапсуляцию
для установки кода ISO, которая центарлизует изменения в самом Объекте Значения:
```php
class Money
{
    private $amount; 
    private $currency;

    public function __construct($anAmount, Currency $aCurrency)
    {
        $this->setAmount($anAmount);
        $this->setCurrency($aCurrency);
    }

    private function setAmount($anAmount)
    {
        $this->amount = (int) $anAmount;
    }

    private function setCurrency(Currency $aCurrency)
    {
        $this->currency = $aCurrency;
    }

    public function amount()
    {
        return $this->amount;
    }

    public function currency()
    {
        return $this->currency;
    }
}
```
Теперь, когда вы знаете формальное определение Объектов Значений, давайте
углубимся в тот мощной функционал который они предоставляют.

## Характеристики
